services:
  # Radicale CalDAV/CardDAV server with privacy extensions
  radicale:
    build:
      context: .
      dockerfile: Dockerfile.local
    container_name: radicale-idp-server

    # Port exposed only within Docker network (nginx will proxy)
    expose:
      - "5232"

    environment:
      # Critical: Bearer token for privacy API authentication
      # MUST match the web app's RADICALE_TOKEN
      - RADICALE_TOKEN=${RADICALE_TOKEN:-changeme}

    volumes:
      # Persistent storage for CalDAV/CardDAV collections
      - radicale_collections:/var/lib/radicale/collections
      # Persistent storage for privacy settings database
      - radicale_data:/var/lib/radicale
      # Read-only configuration
      - ./config/radicale.config:/etc/radicale/config:ro

    # Docker network for inter-service communication
    networks:
      - radicale-network

    # Health check to monitor service status
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5232/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Auto-restart on failure
    restart: unless-stopped

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # React web application for privacy settings management
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: radicale-idp-web

    # Port exposed only within Docker network (nginx will proxy)
    expose:
      - "3000"

    environment:
      # Radicale connection settings
      - RADICALE_URL=http://radicale:5232
      # Bearer token for privacy API (MUST match radicale service)
      - RADICALE_TOKEN=${RADICALE_TOKEN:-changeme}

      # JWT authentication for web app
      - JWT_SECRET=${JWT_SECRET:-change-this-to-a-secure-random-string}

      # Web app database configuration
      - DB_FILE_NAME=/data/local.db

      # AWS SES/SNS configuration for OTP delivery
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - EMAIL_FROM=${EMAIL_FROM}
      - EMAIL_FROM_NAME=${EMAIL_FROM_NAME:-Radicale IDP}

      # For testing/development without AWS credentials
      # Enable mock mode to log OTP codes to console instead of sending via AWS
      - MOCK_EMAIL=${MOCK_EMAIL:-false}
      - MOCK_SMS=${MOCK_SMS:-false}

    volumes:
      # Persistent storage for web app database
      - web_data:/data

    # Depends on radicale service being ready
    depends_on:
      radicale:
        condition: service_healthy

    # Docker network for inter-service communication
    networks:
      - radicale-network

    # Health check - verify app is responding
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Auto-restart on failure
    restart: unless-stopped

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Nginx reverse proxy for external access
  nginx:
    image: nginx:alpine
    container_name: radicale-idp-nginx

    # Expose HTTP and HTTPS to the host
    ports:
      - "80:80"
      - "443:443"

    volumes:
      # Nginx configuration files
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      # SSL certificates (managed by certbot)
      - nginx_certs:/etc/nginx/ssl
      # Let's Encrypt challenge directory
      - nginx_challenge:/var/www/certbot

    # Wait for backend services to be ready
    depends_on:
      radicale:
        condition: service_healthy
      web:
        condition: service_healthy

    # Docker network for inter-service communication
    networks:
      - radicale-network

    # Health check to monitor nginx status
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

    # Auto-restart on failure
    restart: unless-stopped

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Certbot for SSL certificate management
  certbot:
    image: certbot/certbot
    container_name: radicale-idp-certbot

    volumes:
      # Share certificate storage with nginx
      - nginx_certs:/etc/letsencrypt
      # Share challenge directory with nginx
      - nginx_challenge:/var/www/certbot

    # Run certificate renewal check every 12 hours
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

    # Docker network for inter-service communication
    networks:
      - radicale-network

    # Auto-restart on failure
    restart: unless-stopped

# Shared Docker network for service communication
networks:
  radicale-network:
    driver: bridge

# Named volumes for persistent data
volumes:
  # CalDAV/CardDAV collections storage
  radicale_collections:
    driver: local

  # Radicale data (privacy database, cache, etc)
  radicale_data:
    driver: local

  # Web application data (SQLite database, etc)
  web_data:
    driver: local

  # SSL/TLS certificates from Let's Encrypt
  nginx_certs:
    driver: local

  # Let's Encrypt ACME challenge files
  nginx_challenge:
    driver: local
